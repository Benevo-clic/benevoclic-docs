# Manuel de Mise √† Jour - Benevoclic

## Vue d'ensemble

Ce manuel d√©taille les proc√©dures de mise √† jour de l'application Benevoclic, couvrant tous les types d'updates (s√©curit√©, fonctionnalit√©s, maintenance) et les environnements (d√©veloppement, staging, production).

## 1. Types de Mises √† Jour

### 1.1 Classification des Updates

#### Mises √† Jour de S√©curit√© (Hotfix)
```typescript
interface SecurityUpdate {
  priority: 'CRITICAL' | 'HIGH' | 'MEDIUM' | 'LOW'
  type: 'SECURITY_VULNERABILITY' | 'SECURITY_PATCH' | 'SECURITY_UPDATE'
  deployment: 'IMMEDIATE' | 'WITHIN_24H' | 'WITHIN_WEEK'
  rollback: boolean
  testing: 'MINIMAL' | 'STANDARD' | 'EXTENSIVE'
}
```

**Caract√©ristiques :**
- üîí **Priorit√© maximale** : D√©ploiement imm√©diat
- ‚ö° **Processus acc√©l√©r√©** : Tests minimaux
- üîÑ **Rollback automatique** : En cas d'√©chec
- üì¢ **Notification urgente** : Tous les stakeholders

#### Mises √† Jour Fonctionnelles (Feature Release)
```typescript
interface FeatureUpdate {
  version: 'MAJOR' | 'MINOR' | 'PATCH'
  features: string[]
  breakingChanges: boolean
  migration: boolean
  documentation: boolean
  training: boolean
}
```

**Caract√©ristiques :**
- üéØ **Nouvelles fonctionnalit√©s** : Ajouts significatifs
- üìö **Documentation compl√®te** : Guides utilisateur
- üß™ **Tests √©tendus** : Validation compl√®te
- üìÖ **Planning d√©taill√©** : Communication pr√©alable

#### Mises √† Jour de Maintenance (Maintenance Release)
```typescript
interface MaintenanceUpdate {
  type: 'PERFORMANCE' | 'BUGFIX' | 'DEPENDENCY' | 'INFRASTRUCTURE'
  impact: 'NONE' | 'LOW' | 'MEDIUM' | 'HIGH'
  downtime: boolean
  userNotification: boolean
}
```

**Caract√©ristiques :**
- üîß **Am√©liorations techniques** : Performance, bugs
- üì¶ **Mise √† jour d√©pendances** : S√©curit√©, compatibilit√©
- üöÄ **Optimisations** : Performance, scalabilit√©
- üìã **Documentation technique** : Changelog d√©taill√©

### 1.2 Cycle de Versioning

#### Convention Semantic Versioning
```bash
# Format : MAJOR.MINOR.PATCH
# Exemple : 2.1.3

MAJOR (2) : Changements incompatibles
MINOR (1) : Nouvelles fonctionnalit√©s compatibles
PATCH (3) : Corrections de bugs compatibles
```

#### Calendrier de Releases
```yaml
# Planning des mises √† jour
releases:
  security:
    frequency: "As needed"
    lead_time: "2-24 hours"
    testing: "Critical path only"
    
  features:
    frequency: "Monthly"
    lead_time: "2 weeks"
    testing: "Full regression"
    
  maintenance:
    frequency: "Weekly"
    lead_time: "3-5 days"
    testing: "Standard suite"
```

## 2. Processus de Mise √† Jour

### 2.1 Pr√©paration de la Mise √† Jour

#### Checklist de Pr√©paration
```markdown
## Checklist Pr√©-Update

### üìã Planification
- [ ] Type de mise √† jour identifi√©
- [ ] Impact √©valu√©
- [ ] Planning √©tabli
- [ ] √âquipe mobilis√©e
- [ ] Communication planifi√©e

### üß™ Tests
- [ ] Tests unitaires passent
- [ ] Tests d'int√©gration valid√©s
- [ ] Tests de r√©gression effectu√©s
- [ ] Tests de performance OK
- [ ] Tests de s√©curit√© valid√©s

### üìö Documentation
- [ ] Changelog r√©dig√©
- [ ] Documentation mise √† jour
- [ ] Guide utilisateur actualis√©
- [ ] Notes de version pr√©par√©es
- [ ] Proc√©dures de rollback document√©es

### üîß Infrastructure
- [ ] Sauvegarde effectu√©e
- [ ] Environnement de test pr√™t
- [ ] Monitoring configur√©
- [ ] Alertes activ√©es
- [ ] √âquipe de support disponible
```

#### √âvaluation d'Impact
```typescript
interface ImpactAssessment {
  users: {
    affected: number
    percentage: number
    userTypes: string[]
  }
  
  functionality: {
    critical: string[]
    important: string[]
    nice_to_have: string[]
  }
  
  technical: {
    database: boolean
    api: boolean
    frontend: boolean
    infrastructure: boolean
  }
  
  business: {
    revenue: 'NONE' | 'LOW' | 'MEDIUM' | 'HIGH'
    reputation: 'NONE' | 'LOW' | 'MEDIUM' | 'HIGH'
    compliance: boolean
  }
}
```

### 2.2 Proc√©dure de D√©ploiement

#### Script de Mise √† Jour Automatis√©
```bash
#!/bin/bash
# update.sh

set -e

# Configuration
UPDATE_TYPE=${1:-maintenance}
VERSION=${2:-latest}
ENVIRONMENT=${3:-production}
BACKUP_ENABLED=true
ROLLBACK_ENABLED=true

echo "üöÄ Mise √† jour Benevoclic - Type: $UPDATE_TYPE, Version: $VERSION, Environnement: $ENVIRONMENT"

# 1. V√©rification des pr√©requis
check_prerequisites() {
    echo "üìã V√©rification des pr√©requis..."
    
    # V√©rification de l'espace disque
    DISK_USAGE=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
    if [ $DISK_USAGE -gt 85 ]; then
        echo "‚ùå Espace disque insuffisant: ${DISK_USAGE}%"
        exit 1
    fi
    
    # V√©rification de la m√©moire
    MEMORY_USAGE=$(free | grep Mem | awk '{printf("%.0f", $3/$2 * 100.0)}')
    if [ $MEMORY_USAGE -gt 90 ]; then
        echo "‚ùå M√©moire insuffisante: ${MEMORY_USAGE}%"
        exit 1
    fi
    
    # V√©rification de la connectivit√©
    if ! curl -f http://localhost/health > /dev/null 2>&1; then
        echo "‚ùå Application non accessible"
        exit 1
    fi
}

# 2. Sauvegarde pr√©ventive
create_backup() {
    if [ "$BACKUP_ENABLED" = true ]; then
        echo "üíæ Cr√©ation de la sauvegarde..."
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        
        # Sauvegarde base de donn√©es
        docker exec benevoclic-mongo mongodump --out /data/backup_pre_update_$TIMESTAMP
        
        # Sauvegarde configuration
        tar -czf /backups/config_pre_update_$TIMESTAMP.tar.gz \
            docker-compose.prod.yml \
            .env.production \
            nginx.conf
        
        echo "‚úÖ Sauvegarde cr√©√©e: backup_pre_update_$TIMESTAMP"
    fi
}

# 3. Notification pr√©-update
notify_pre_update() {
    echo "üì¢ Notification pr√©-update..."
    curl -X POST $DISCORD_WEBHOOK \
        -H "Content-Type: application/json" \
        -d "{\"content\": \"üîÑ Mise √† jour $UPDATE_TYPE v$VERSION en cours sur $ENVIRONMENT\"}"
}

# 4. D√©ploiement de la mise √† jour
deploy_update() {
    echo "üöÄ D√©ploiement de la mise √† jour..."
    
    # Pull des nouvelles images
    docker-compose -f docker-compose.$ENVIRONMENT.yml pull
    
    # Arr√™t des services
    docker-compose -f docker-compose.$ENVIRONMENT.yml down
    
    # D√©marrage avec nouvelle version
    docker-compose -f docker-compose.$ENVIRONMENT.yml up -d
    
    echo "‚úÖ D√©ploiement termin√©"
}

# 5. V√©rification post-update
verify_update() {
    echo "‚úÖ V√©rification post-update..."
    sleep 30
    
    # V√©rification sant√© des services
    if ! curl -f http://localhost/health > /dev/null 2>&1; then
        echo "‚ùå √âchec de la v√©rification de sant√©"
        if [ "$ROLLBACK_ENABLED" = true ]; then
            rollback_update
        fi
        exit 1
    fi
    
    # V√©rification version
    VERSION_CHECK=$(curl -s http://localhost/api/version | jq -r '.version')
    if [ "$VERSION_CHECK" != "$VERSION" ]; then
        echo "‚ùå Version incorrecte: $VERSION_CHECK (attendu: $VERSION)"
        if [ "$ROLLBACK_ENABLED" = true ]; then
            rollback_update
        fi
        exit 1
    fi
    
    echo "‚úÖ V√©rification r√©ussie"
}

# 6. Tests de r√©gression
run_regression_tests() {
    if [ "$UPDATE_TYPE" != "security" ]; then
        echo "üß™ Tests de r√©gression..."
        npm run test:regression
    fi
}

# 7. Notification de succ√®s
notify_success() {
    echo "üì¢ Notification de succ√®s..."
    curl -X POST $DISCORD_WEBHOOK \
        -H "Content-Type: application/json" \
        -d "{\"content\": \"‚úÖ Mise √† jour $UPDATE_TYPE v$VERSION r√©ussie sur $ENVIRONMENT\"}"
}

# 8. Rollback en cas d'√©chec
rollback_update() {
    echo "üîÑ Rollback de la mise √† jour..."
    
    # Restauration des images pr√©c√©dentes
    docker tag benevoclic/api:previous benevoclic/api:latest
    docker tag benevoclic/web:previous benevoclic/web:latest
    
    # Red√©marrage avec ancienne version
    docker-compose -f docker-compose.$ENVIRONMENT.yml down
    docker-compose -f docker-compose.$ENVIRONMENT.yml up -d
    
    # Notification de rollback
    curl -X POST $DISCORD_WEBHOOK \
        -H "Content-Type: application/json" \
        -d "{\"content\": \"üîÑ Rollback effectu√© pour la mise √† jour $UPDATE_TYPE v$VERSION\"}"
}

# Ex√©cution principale
main() {
    check_prerequisites
    create_backup
    notify_pre_update
    deploy_update
    verify_update
    run_regression_tests
    notify_success
    
    echo "üéâ Mise √† jour termin√©e avec succ√®s!"
}

main
```

### 2.3 Proc√©dure de Rollback

#### Script de Rollback Automatique
```bash
#!/bin/bash
# rollback.sh

set -e

PREVIOUS_VERSION=$1
REASON=${2:-"√âchec de la mise √† jour"}

echo "üîÑ Rollback vers la version $PREVIOUS_VERSION - Raison: $REASON"

# 1. Sauvegarde de l'√©tat actuel
backup_current_state() {
    echo "üíæ Sauvegarde de l'√©tat actuel..."
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    docker exec benevoclic-mongo mongodump --out /data/backup_before_rollback_$TIMESTAMP
}

# 2. Restauration de la version pr√©c√©dente
restore_previous_version() {
    echo "üîÑ Restauration de la version pr√©c√©dente..."
    
    # Tag de la version pr√©c√©dente
    docker tag benevoclic/api:$PREVIOUS_VERSION benevoclic/api:latest
    docker tag benevoclic/web:$PREVIOUS_VERSION benevoclic/web:latest
    
    # Red√©marrage des services
    docker-compose -f docker-compose.prod.yml down
    docker-compose -f docker-compose.prod.yml up -d
}

# 3. V√©rification post-rollback
verify_rollback() {
    echo "‚úÖ V√©rification du rollback..."
    sleep 30
    
    if curl -f http://localhost/health > /dev/null 2>&1; then
        echo "‚úÖ Rollback r√©ussi"
    else
        echo "‚ùå √âchec du rollback"
        exit 1
    fi
}

# 4. Notification
notify_rollback() {
    curl -X POST $DISCORD_WEBHOOK \
        -H "Content-Type: application/json" \
        -d "{\"content\": \"üîÑ Rollback vers $PREVIOUS_VERSION effectu√© - Raison: $REASON\"}"
}

main() {
    backup_current_state
    restore_previous_version
    verify_rollback
    notify_rollback
    
    echo "üéâ Rollback termin√© avec succ√®s!"
}

main
```

## 3. Mises √† Jour Sp√©cifiques

### 3.1 Mise √† Jour de S√©curit√©

#### Proc√©dure d'Urgence
```bash
#!/bin/bash
# security-update.sh

set -e

VULNERABILITY_ID=$1
SEVERITY=$2

echo "üö® Mise √† jour de s√©curit√© - Vuln√©rabilit√©: $VULNERABILITY_ID, S√©v√©rit√©: $SEVERITY"

# 1. √âvaluation de l'urgence
assess_urgency() {
    case $SEVERITY in
        "CRITICAL")
            DEPLOYMENT_TIME="IMMEDIATE"
            TESTING_LEVEL="MINIMAL"
            ;;
        "HIGH")
            DEPLOYMENT_TIME="WITHIN_2H"
            TESTING_LEVEL="CRITICAL_PATH"
            ;;
        "MEDIUM")
            DEPLOYMENT_TIME="WITHIN_24H"
            TESTING_LEVEL="STANDARD"
            ;;
        *)
            DEPLOYMENT_TIME="WITHIN_WEEK"
            TESTING_LEVEL="FULL"
            ;;
    esac
}

# 2. Tests critiques uniquement
run_critical_tests() {
    echo "üß™ Tests critiques..."
    npm run test:security
    npm run test:critical
}

# 3. D√©ploiement acc√©l√©r√©
accelerated_deploy() {
    echo "‚ö° D√©ploiement acc√©l√©r√©..."
    docker-compose -f docker-compose.prod.yml pull
    docker-compose -f docker-compose.prod.yml up -d --no-deps api
}

# 4. V√©rification imm√©diate
immediate_verification() {
    echo "üè• V√©rification imm√©diate..."
    sleep 10
    
    if curl -f http://localhost:3000/health > /dev/null 2>&1; then
        echo "‚úÖ Mise √† jour de s√©curit√© d√©ploy√©e"
    else
        echo "‚ùå √âchec, rollback automatique"
        rollback_update
    fi
}

# 5. Notification d'urgence
notify_emergency() {
    curl -X POST $DISCORD_WEBHOOK \
        -H "Content-Type: application/json" \
        -d "{\"content\": \"üö® Mise √† jour de s√©curit√© $VULNERABILITY_ID d√©ploy√©e - S√©v√©rit√©: $SEVERITY\"}"
}

main() {
    assess_urgency
    run_critical_tests
    accelerated_deploy
    immediate_verification
    notify_emergency
}

main
```

### 3.2 Mise √† Jour de Base de Donn√©es

#### Script de Migration
```typescript
// database-migration.ts
interface DatabaseMigration {
  version: string
  description: string
  up: () => Promise<void>
  down: () => Promise<void>
  dependencies: string[]
  rollback: boolean
}

// Exemple de migration
export const migration_20240815_add_user_preferences: DatabaseMigration = {
  version: '20240815_001',
  description: 'Ajout des pr√©f√©rences utilisateur',
  
  async up() {
    // Cr√©ation de la collection preferences
    await db.createCollection('preferences')
    
    // Ajout des index
    await db.collection('preferences').createIndex({ userId: 1 })
    await db.collection('preferences').createIndex({ category: 1 })
    
    // Migration des donn√©es existantes
    const users = await db.collection('users').find({}).toArray()
    for (const user of users) {
      await db.collection('preferences').insertOne({
        userId: user._id,
        category: 'notifications',
        settings: {
          email: true,
          push: true,
          sms: false
        },
        createdAt: new Date(),
        updatedAt: new Date()
      })
    }
  },
  
  async down() {
    // Suppression de la collection
    await db.collection('preferences').drop()
  },
  
  dependencies: [],
  rollback: true
}
```

#### Script d'Ex√©cution des Migrations
```bash
#!/bin/bash
# migrate.sh

set -e

TARGET_VERSION=${1:-latest}
DRY_RUN=${2:-false}

echo "üóÑÔ∏è Migration de la base de donn√©es vers la version $TARGET_VERSION"

# 1. Sauvegarde pr√©-migration
backup_database() {
    echo "üíæ Sauvegarde pr√©-migration..."
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    docker exec benevoclic-mongo mongodump --out /data/backup_pre_migration_$TIMESTAMP
}

# 2. V√©rification de l'espace disque
check_disk_space() {
    DISK_USAGE=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
    if [ $DISK_USAGE -gt 90 ]; then
        echo "‚ùå Espace disque insuffisant pour la migration"
        exit 1
    fi
}

# 3. Ex√©cution des migrations
run_migrations() {
    echo "üîÑ Ex√©cution des migrations..."
    
    if [ "$DRY_RUN" = true ]; then
        echo "üß™ Mode dry-run - Aucune modification"
        npm run migrate:dry-run
    else
        npm run migrate:up -- --target $TARGET_VERSION
    fi
}

# 4. V√©rification post-migration
verify_migration() {
    echo "‚úÖ V√©rification post-migration..."
    
    # V√©rification de l'int√©grit√©
    npm run migrate:verify
    
    # Tests de r√©gression
    npm run test:database
}

# 5. Notification
notify_migration() {
    curl -X POST $DISCORD_WEBHOOK \
        -H "Content-Type: application/json" \
        -d "{\"content\": \"üóÑÔ∏è Migration DB vers $TARGET_VERSION termin√©e\"}"
}

main() {
    backup_database
    check_disk_space
    run_migrations
    verify_migration
    notify_migration
    
    echo "üéâ Migration termin√©e avec succ√®s!"
}

main
```

### 3.3 Mise √† Jour des D√©pendances

#### Script de Mise √† Jour des D√©pendances
```bash
#!/bin/bash
# update-dependencies.sh

set -e

PACKAGE_MANAGER=${1:-npm}
UPDATE_TYPE=${2:-patch}

echo "üì¶ Mise √† jour des d√©pendances - Type: $UPDATE_TYPE"

# 1. V√©rification des vuln√©rabilit√©s
check_vulnerabilities() {
    echo "üîç V√©rification des vuln√©rabilit√©s..."
    npm audit
    
    if [ $? -ne 0 ]; then
        echo "‚ö†Ô∏è Vuln√©rabilit√©s d√©tect√©es"
        read -p "Continuer malgr√© les vuln√©rabilit√©s ? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
}

# 2. Sauvegarde des fichiers de d√©pendances
backup_dependencies() {
    echo "üíæ Sauvegarde des d√©pendances..."
    cp package.json package.json.backup
    cp package-lock.json package-lock.json.backup
}

# 3. Mise √† jour des d√©pendances
update_dependencies() {
    echo "üì¶ Mise √† jour des d√©pendances..."
    
    case $UPDATE_TYPE in
        "major")
            npx npm-check-updates -u
            ;;
        "minor")
            npx npm-check-updates -u --target minor
            ;;
        "patch")
            npx npm-check-updates -u --target patch
            ;;
        "security")
            npm audit fix
            ;;
        *)
            echo "‚ùå Type de mise √† jour invalide"
            exit 1
            ;;
    esac
}

# 4. Installation des nouvelles d√©pendances
install_dependencies() {
    echo "üì• Installation des nouvelles d√©pendances..."
    npm ci
}

# 5. Tests de r√©gression
run_tests() {
    echo "üß™ Tests de r√©gression..."
    npm run test:all
}

# 6. Build de v√©rification
verify_build() {
    echo "üî® V√©rification du build..."
    npm run build
}

# 7. Notification
notify_dependency_update() {
    curl -X POST $DISCORD_WEBHOOK \
        -H "Content-Type: application/json" \
        -d "{\"content\": \"üì¶ Mise √† jour des d√©pendances $UPDATE_TYPE termin√©e\"}"
}

main() {
    check_vulnerabilities
    backup_dependencies
    update_dependencies
    install_dependencies
    run_tests
    verify_build
    notify_dependency_update
    
    echo "üéâ Mise √† jour des d√©pendances termin√©e!"
}

main
```

## 4. Communication et Notification

### 4.1 Plan de Communication

#### Template de Communication
```markdown
# Communication de Mise √† Jour

## üì¢ Annonce Pr√©alable

**Objet :** Mise √† jour Benevoclic - [Type] - [Date]

**Destinataires :** [Liste des destinataires]

**Contenu :**
- Type de mise √† jour : [S√©curit√©/Fonctionnelle/Maintenance]
- Date pr√©vue : [Date et heure]
- Dur√©e estim√©e : [Dur√©e]
- Impact utilisateur : [Aucun/Faible/Moyen/√âlev√©]
- Nouvelles fonctionnalit√©s : [Liste]
- Corrections : [Liste]

**Actions requises :** [Aucune/Sauvegarde/Formation]

---

## üîÑ Pendant la Mise √† Jour

**Statut :** Mise √† jour en cours
**Progression :** [X%]
**Temps restant :** [Estimation]

---

## ‚úÖ Confirmation de Succ√®s

**Statut :** Mise √† jour termin√©e avec succ√®s
**Nouvelles fonctionnalit√©s :** [Liste]
**Notes importantes :** [Informations]
**Support :** [Contact]

---

## ‚ùå En Cas de Probl√®me

**Statut :** Probl√®me d√©tect√©
**Description :** [Description du probl√®me]
**Actions en cours :** [Actions]
**Temps de r√©solution estim√© :** [Estimation]
```

### 4.2 Canaux de Notification

#### Configuration des Notifications
```typescript
interface NotificationChannels {
  internal: {
    email: string[]
    slack: string[]
    discord: string[]
    sms: string[]
  }
  
  external: {
    users: boolean
    partners: boolean
    public: boolean
  }
  
  timing: {
    preUpdate: number // heures avant
    duringUpdate: boolean
    postUpdate: boolean
    onFailure: boolean
  }
}

// Configuration des notifications
const notificationConfig: NotificationChannels = {
  internal: {
    email: ['tech@benevoclic.fr', 'admin@benevoclic.fr'],
    slack: ['#tech', '#alerts'],
    discord: ['#updates', '#alerts'],
    sms: ['+33123456789']
  },
  
  external: {
    users: true,
    partners: true,
    public: false
  },
  
  timing: {
    preUpdate: 24,
    duringUpdate: true,
    postUpdate: true,
    onFailure: true
  }
}
```

#### Script de Notification Automatis√©
```bash
#!/bin/bash
# notify.sh

set -e

UPDATE_TYPE=$1
STATUS=$2
MESSAGE=$3

echo "üì¢ Notification - Type: $UPDATE_TYPE, Statut: $STATUS"

# Configuration des webhooks
DISCORD_WEBHOOK="https://discord.com/api/webhooks/your_webhook"
SLACK_WEBHOOK="https://hooks.slack.com/services/your_webhook"
EMAIL_SERVICE="smtp.gmail.com"

# Notification Discord
notify_discord() {
    local color
    case $STATUS in
        "success") color="00ff00" ;;
        "warning") color="ffff00" ;;
        "error") color="ff0000" ;;
        *) color="0099ff" ;;
    esac
    
    curl -X POST $DISCORD_WEBHOOK \
        -H "Content-Type: application/json" \
        -d "{
            \"embeds\": [{
                \"title\": \"Mise √† jour $UPDATE_TYPE\",
                \"description\": \"$MESSAGE\",
                \"color\": $color,
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
            }]
        }"
}

# Notification Slack
notify_slack() {
    curl -X POST $SLACK_WEBHOOK \
        -H "Content-Type: application/json" \
        -d "{
            \"text\": \"*Mise √† jour $UPDATE_TYPE* - $STATUS\n$MESSAGE\"
        }"
}

# Notification Email
notify_email() {
    echo "üìß Envoi de l'email..."
    # Utilisation de sendmail ou autre service SMTP
    echo "Subject: Mise √† jour Benevoclic - $UPDATE_TYPE" | sendmail $EMAIL_RECIPIENTS
}

# Notification SMS
notify_sms() {
    echo "üì± Envoi du SMS..."
    # Utilisation d'un service SMS (Twilio, etc.)
    curl -X POST "https://api.twilio.com/2010-04-01/Accounts/$TWILIO_ACCOUNT/Messages.json" \
        -u "$TWILIO_ACCOUNT:$TWILIO_TOKEN" \
        -d "Body=Mise √† jour $UPDATE_TYPE: $STATUS - $MESSAGE" \
        -d "To=$SMS_RECIPIENT" \
        -d "From=$TWILIO_NUMBER"
}

# Ex√©cution des notifications
main() {
    case $STATUS in
        "pre_update")
            notify_discord
            notify_slack
            notify_email
            ;;
        "success")
            notify_discord
            notify_slack
            notify_email
            ;;
        "error")
            notify_discord
            notify_slack
            notify_email
            notify_sms
            ;;
        *)
            echo "‚ùå Statut invalide: $STATUS"
            exit 1
            ;;
    esac
    
    echo "‚úÖ Notifications envoy√©es"
}

main
```

## 5. Monitoring et Surveillance

### 5.1 M√©triques de Surveillance

#### Configuration Prometheus
```yaml
# prometheus-update-monitoring.yml
global:
  scrape_interval: 15s

rule_files:
  - "update-alert-rules.yml"

scrape_configs:
  - job_name: 'benevoclic-update-monitoring'
    static_configs:
      - targets: ['localhost:3000']
    metrics_path: '/metrics'
    scrape_interval: 10s
    
  - job_name: 'database-migration-monitoring'
    static_configs:
      - targets: ['localhost:27017']
    scrape_interval: 30s
```

#### R√®gles d'Alerte pour les Mises √† Jour
```yaml
# update-alert-rules.yml
groups:
  - name: update_monitoring
    rules:
      - alert: UpdateInProgress
        expr: benevoclic_update_status == 1
        for: 1m
        labels:
          severity: info
        annotations:
          summary: "Mise √† jour en cours"
          
      - alert: UpdateFailed
        expr: benevoclic_update_status == 2
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "√âchec de la mise √† jour"
          
      - alert: HighErrorRateAfterUpdate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Taux d'erreur √©lev√© apr√®s mise √† jour"
          
      - alert: DatabaseMigrationFailed
        expr: benevoclic_db_migration_status == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "√âchec de migration de base de donn√©es"
```

### 5.2 Dashboard de Surveillance

#### Configuration Grafana
```json
{
  "dashboard": {
    "title": "Benevoclic Update Monitoring",
    "panels": [
      {
        "title": "Status des Mises √† Jour",
        "type": "stat",
        "targets": [
          {
            "expr": "benevoclic_update_status",
            "legendFormat": "{{status}}"
          }
        ]
      },
      {
        "title": "Taux d'Erreur Post-Update",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(http_requests_total{status=~\"5..\"}[5m])",
            "legendFormat": "Erreurs 5xx"
          }
        ]
      },
      {
        "title": "Performance Post-Update",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "Temps de r√©ponse 95e percentile"
          }
        ]
      }
    ]
  }
}
```

## 6. Documentation et Formation

### 6.1 Documentation des Mises √† Jour

#### Template de Documentation
```markdown
# Documentation de Mise √† Jour - v[VERSION]

## üìã Informations G√©n√©rales

- **Version** : [VERSION]
- **Date de release** : [DATE]
- **Type** : [S√©curit√©/Fonctionnelle/Maintenance]
- **Responsable** : [NOM]
- **Dur√©e estim√©e** : [DUR√âE]

## üéØ Objectifs

### Objectifs Principaux
- [Objectif 1]
- [Objectif 2]
- [Objectif 3]

### Objectifs Secondaires
- [Objectif secondaire 1]
- [Objectif secondaire 2]

## üîß Modifications Techniques

### Frontend
- [Modification 1]
- [Modification 2]

### Backend
- [Modification 1]
- [Modification 2]

### Base de Donn√©es
- [Migration 1]
- [Migration 2]

### Infrastructure
- [Modification 1]
- [Modification 2]

## üß™ Tests Effectu√©s

### Tests Unitaires
- [ ] Test 1
- [ ] Test 2

### Tests d'Int√©gration
- [ ] Test 1
- [ ] Test 2

### Tests de Performance
- [ ] Test 1
- [ ] Test 2

### Tests de S√©curit√©
- [ ] Test 1
- [ ] Test 2

## üìö Documentation Utilisateur

### Nouvelles Fonctionnalit√©s
- [Fonctionnalit√© 1]
- [Fonctionnalit√© 2]

### Modifications d'Interface
- [Modification 1]
- [Modification 2]

### Guide de Migration
- [√âtape 1]
- [√âtape 2]

## üö® Risques et Mitigation

### Risques Identifi√©s
- **Risque 1** : [Description]
  - **Impact** : [Faible/Moyen/√âlev√©]
  - **Probabilit√©** : [Faible/Moyenne/√âlev√©e]
  - **Mitigation** : [Mesure de mitigation]

### Plan de Rollback
- [√âtape 1]
- [√âtape 2]

## üìä M√©triques de Succ√®s

### KPIs √† Surveiller
- [KPI 1] : [Valeur cible]
- [KPI 2] : [Valeur cible]

### M√©triques de Performance
- [M√©trique 1] : [Valeur attendue]
- [M√©trique 2] : [Valeur attendue]

## üìû Support et Contact

### √âquipe de Support
- **Technique** : [Contact]
- **Fonctionnel** : [Contact]
- **Utilisateur** : [Contact]

### Ressources
- **Documentation** : [Lien]
- **Support** : [Lien]
- **Statut** : [Lien]
```

### 6.2 Formation des √âquipes

#### Programme de Formation
```markdown
# Programme de Formation - Mise √† Jour v[VERSION]

## üéØ Objectifs de Formation

### Objectifs G√©n√©raux
- Comprendre les nouvelles fonctionnalit√©s
- Ma√Ætriser les proc√©dures de mise √† jour
- Savoir g√©rer les incidents post-update

### Objectifs Sp√©cifiques par R√¥le

#### D√©veloppeurs
- [Objectif 1]
- [Objectif 2]

#### DevOps
- [Objectif 1]
- [Objectif 2]

#### Support
- [Objectif 1]
- [Objectif 2]

## üìÖ Planning de Formation

### Session 1 : Pr√©sentation G√©n√©rale
- **Dur√©e** : 2h
- **Participants** : Toute l'√©quipe
- **Contenu** :
  - Pr√©sentation des nouvelles fonctionnalit√©s
  - Impact sur les utilisateurs
  - Planning de d√©ploiement

### Session 2 : Formation Technique
- **Dur√©e** : 4h
- **Participants** : D√©veloppeurs + DevOps
- **Contenu** :
  - Architecture technique
  - Proc√©dures de d√©ploiement
  - Monitoring et surveillance

### Session 3 : Formation Support
- **Dur√©e** : 3h
- **Participants** : √âquipe support
- **Contenu** :
  - Nouvelles fonctionnalit√©s utilisateur
  - Proc√©dures de support
  - Gestion des incidents

## üìö Supports de Formation

### Documentation
- [Lien vers la documentation]
- [Lien vers les guides utilisateur]
- [Lien vers les proc√©dures]

### Vid√©os
- [Lien vers les tutoriels vid√©o]
- [Lien vers les d√©monstrations]

### Exercices Pratiques
- [Lien vers les exercices]
- [Lien vers les cas d'usage]

## ‚úÖ Validation des Comp√©tences

### Quiz de Validation
- [Lien vers le quiz]
- [Score minimum requis]

### Exercices Pratiques
- [Lien vers les exercices]
- [Crit√®res de validation]

### Certification
- [Attestation de formation]
- [Certification de comp√©tences]
```

## 7. Gestion des Incidents Post-Update

### 7.1 Proc√©dure d'Incident

#### Script de Gestion d'Incident
```bash
#!/bin/bash
# incident-response.sh

set -e

INCIDENT_TYPE=$1
SEVERITY=$2
DESCRIPTION=$3

echo "üö® Gestion d'incident - Type: $INCIDENT_TYPE, S√©v√©rit√©: $SEVERITY"

# 1. √âvaluation de l'incident
assess_incident() {
    echo "üîç √âvaluation de l'incident..."
    
    case $SEVERITY in
        "CRITICAL")
            RESPONSE_TIME="IMMEDIATE"
            ESCALATION_LEVEL="LEVEL3"
            ;;
        "HIGH")
            RESPONSE_TIME="WITHIN_30MIN"
            ESCALATION_LEVEL="LEVEL2"
            ;;
        "MEDIUM")
            RESPONSE_TIME="WITHIN_2H"
            ESCALATION_LEVEL="LEVEL1"
            ;;
        "LOW")
            RESPONSE_TIME="WITHIN_24H"
            ESCALATION_LEVEL="NONE"
            ;;
    esac
}

# 2. Mobilisation de l'√©quipe
mobilize_team() {
    echo "üë• Mobilisation de l'√©quipe..."
    
    # Notification de l'√©quipe
    curl -X POST $DISCORD_WEBHOOK \
        -H "Content-Type: application/json" \
        -d "{\"content\": \"üö® INCIDENT $SEVERITY - $INCIDENT_TYPE - $DESCRIPTION\"}"
    
    # Cr√©ation du ticket d'incident
    # Int√©gration avec le syst√®me de ticketing
}

# 3. Diagnostic initial
initial_diagnosis() {
    echo "üîç Diagnostic initial..."
    
    # V√©rification de sant√© des services
    curl -f http://localhost/health || echo "Service principal hors ligne"
    curl -f http://localhost:3000/health || echo "API hors ligne"
    
    # V√©rification des logs
    docker-compose -f docker-compose.prod.yml logs --tail=50
    
    # V√©rification des m√©triques
    curl -s http://localhost:9090/api/v1/query?query=up
}

# 4. Actions correctives
corrective_actions() {
    echo "üîß Actions correctives..."
    
    case $INCIDENT_TYPE in
        "PERFORMANCE")
            # Optimisation des performances
            docker-compose -f docker-compose.prod.yml restart
            ;;
        "DATABASE")
            # V√©rification de la base de donn√©es
            docker exec benevoclic-mongo mongosh --eval "db.adminCommand('ping')"
            ;;
        "SECURITY")
            # Actions de s√©curit√©
            # Mise en place de mesures de protection
            ;;
        *)
            echo "‚ùå Type d'incident non reconnu"
            ;;
    esac
}

# 5. Communication
communicate_incident() {
    echo "üì¢ Communication de l'incident..."
    
    # Communication interne
    curl -X POST $DISCORD_WEBHOOK \
        -H "Content-Type: application/json" \
        -d "{\"content\": \"üì¢ INCIDENT: $DESCRIPTION - Actions en cours\"}"
    
    # Communication externe si n√©cessaire
    if [ "$SEVERITY" = "CRITICAL" ] || [ "$SEVERITY" = "HIGH" ]; then
        # Notification des utilisateurs
        # Mise √† jour du statut
    fi
}

# 6. Suivi et r√©solution
follow_up() {
    echo "üìã Suivi de l'incident..."
    
    # Cr√©ation du rapport d'incident
    cat > incident_report_$(date +%Y%m%d_%H%M%S).md << EOF
# Rapport d'Incident

## Informations G√©n√©rales
- **Type** : $INCIDENT_TYPE
- **S√©v√©rit√©** : $SEVERITY
- **Description** : $DESCRIPTION
- **Date** : $(date)
- **Responsable** : [NOM]

## Actions Effectu√©es
- [Action 1]
- [Action 2]

## R√©solution
- [Description de la r√©solution]

## Pr√©vention
- [Mesures de pr√©vention]
EOF
}

main() {
    assess_incident
    mobilize_team
    initial_diagnosis
    corrective_actions
    communicate_incident
    follow_up
    
    echo "‚úÖ Gestion d'incident termin√©e"
}

main
```

### 7.2 Analyse Post-Incident

#### Template d'Analyse
```markdown
# Analyse Post-Incident - [DATE]

## üìã R√©sum√© de l'Incident

- **Date et heure** : [DATE_HEURE]
- **Dur√©e** : [DUR√âE]
- **Type** : [TYPE]
- **S√©v√©rit√©** : [S√âV√âRIT√â]
- **Impact** : [IMPACT]

## üîç Analyse des Causes

### Cause Racine
[Description de la cause racine]

### Causes Contributives
- [Cause 1]
- [Cause 2]
- [Cause 3]

## üìä Impact

### Impact Utilisateur
- **Utilisateurs affect√©s** : [NOMBRE]
- **Fonctionnalit√©s impact√©es** : [LISTE]
- **Perte de donn√©es** : [OUI/NON]

### Impact Business
- **Perte de revenus** : [MONTANT]
- **R√©putation** : [IMPACT]
- **Conformit√©** : [IMPACT]

## üîß Actions Correctives

### Actions Imm√©diates
- [ ] [Action 1]
- [ ] [Action 2]

### Actions √† Moyen Terme
- [ ] [Action 1]
- [ ] [Action 2]

### Actions √† Long Terme
- [ ] [Action 1]
- [ ] [Action 2]

## üìà Am√©liorations

### Processus
- [Am√©lioration 1]
- [Am√©lioration 2]

### Outils
- [Am√©lioration 1]
- [Am√©lioration 2]

### Formation
- [Am√©lioration 1]
- [Am√©lioration 2]

## üìÖ Suivi

### Actions de Suivi
- [ ] [Action 1] - [DATE]
- [ ] [Action 2] - [DATE]

### M√©triques de Surveillance
- [M√©trique 1] : [Valeur cible]
- [M√©trique 2] : [Valeur cible]

## üìû Contacts

### √âquipe Responsable
- **Responsable technique** : [NOM]
- **Responsable fonctionnel** : [NOM]
- **Responsable communication** : [NOM]
```

## Conclusion

Ce manuel de mise √† jour fournit un cadre complet pour g√©rer tous les types de mises √† jour de l'application Benevoclic. Il couvre :

- **Planification** : √âvaluation d'impact et pr√©paration
- **Ex√©cution** : Proc√©dures automatis√©es et s√©curis√©es
- **Surveillance** : Monitoring et alertes en temps r√©el
- **Communication** : Notifications et documentation
- **Gestion d'incidents** : Proc√©dures de r√©solution et d'analyse

Cette approche garantit des mises √† jour fiables, s√©curis√©es et transparentes, minimisant les risques et maximisant la satisfaction des utilisateurs. 